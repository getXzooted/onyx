#!/bin/bash

# ==============================================================================
#                             ONYX CLI CONTROLLER
#                 The central command hub for the Onyx Gateway.
# ==============================================================================

# 1. ESTABLISH ROOT CONTEXT
# We use readlink to find the actual project folder, even if this script is a symlink.
CURRENT_SCRIPT_PATH="$(readlink -f "$0")"
ONYX_ROOT="$(dirname "$(dirname "$CURRENT_SCRIPT_PATH")")"
CORE_DIR="$ONYX_ROOT/core"
MODULES_DIR="$ONYX_ROOT/modules"

# 2. LOAD DEPENDENCIES
# Logger is required for all scripts
if [ -f "$CORE_DIR/logger.sh" ]; then
    source "$CORE_DIR/logger.sh"
else
    echo "CRITICAL ERROR: Logger not found at $CORE_DIR/logger.sh"
    exit 1
fi

# Load Config Parser to read onyx.yml
if [ -f "$CORE_DIR/config_parser.sh" ]; then
    source "$CORE_DIR/config_parser.sh"
    # Run the load function immediately
    load_config
else
    log_warning "Config parser not found. Running with defaults."
fi

# 3. ROOT CHECK
if [[ $EUID -ne 0 ]]; then
   log_error "Onyx must be run as root. Try: sudo onyx $1"
   exit 1
fi

# 4. USAGE MENU
function show_usage() {
    echo -e "\n${BOLD}Onyx Gateway${NC} - Privacy Focused Router"
    echo -e "Usage: sudo onyx [COMMAND]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo -e "  ${GREEN}install${NC}    bootstrap  -> Installs all dependencies and software."
    echo -e "  ${GREEN}provision${NC}  configure  -> Ingests keys and locks down the system."
    echo -e "  ${GREEN}config${NC}     update     -> Re-applies settings from onyx.yml."
    echo -e "  ${GREEN}status${NC}     check      -> Shows VPN connection and security status."
    echo ""
}

# 5. COMMAND ROUTER
COMMAND="$1"

case "$COMMAND" in

    install)
        # Import the Resume Logic
        source "$MODULES_DIR/system/resume.sh"

        # CHECK: Are we resuming from a reboot?
        if system_check_resume_state; then
            # ==========================================
            # PHASE 2: APPLICATION LAYER (Post-Reboot)
            # ==========================================
            log_header "RESUMING INSTALLATION (PHASE 2)"
            
            # 1. DNS Services (Unbound)
            log_info "Phase 2a: DNS Services"
            source "$MODULES_DIR/dns/configure_unbound.sh"
            source "$MODULES_DIR/dns/set_routing.sh"
            # (Assuming these scripts auto-run their main functions or you add them here)

            # 2. RaspAP Hotspot (The Web Interface)
            log_info "Phase 2b: RaspAP Hotspot"
            source "$MODULES_DIR/system/raspap.sh"
            
            # 3. Dashboard (The CLI Monitor)
            log_info "Phase 2c: CLI Dashboard"
            source "$MODULES_DIR/system/dashboard.sh"
            system_install_dashboard

            # 4. Auto-Provisioning Service (The USB Watcher)
            log_info "Phase 2d: Auto-Provisioning Service"
            source "$MODULES_DIR/provision/install_service.sh"
            provision_install_service

            # 5. Secure Uplink (Final Lock)
            log_info "Phase 2e: Securing Uplink"
            source "$MODULES_DIR/system/tuning.sh"
            system_secure_uplink
            
            # 6. Cleanup (Delete the resume service)
            system_cleanup_resume
            
            log_success "ONYX INSTALLATION COMPLETE."
            log_info "Run 'sudo onyx monitor' to view dashboard."
            
        else
            # ==========================================
            # PHASE 1: SYSTEM LAYER (Pre-Reboot)
            # ==========================================
            log_header "STARTING INSTALLATION (PHASE 1)"
            
            # 1. System Bootstrap (Updates)
            log_info "Phase 1: System Bootstrap & Hardening"
            source "$MODULES_DIR/system/bootstrap.sh"
            source "$MODULES_DIR/system/hardening.sh"
            
            # 2. Schedule Reboot & Resume
            # This creates the service and reboots the machine.
            system_setup_resume
        fi
        ;;

    installOld)
        log_header "STARTING ONYX INSTALLATION"
        
        # 1. System Setup
        log_info "Phase 1: System Bootstrap & Hardening"
        source "$MODULES_DIR/system/bootstrap.sh"
        source "$MODULES_DIR/system/hardening.sh"

        # 2. DNS Setup (Unbound)
        log_info "Phase 2: DNS Services"
        source "$MODULES_DIR/dns/configure_unbound.sh"
        source "$MODULES_DIR/dns/set_routing.sh"

        # 3. RaspAP (Hotspot)
        log_info "Phase 2: RaspAP Hotspot"
        source "$MODULES_DIR/system/raspap.sh"

        # 4. Auto-Provisioning Setup
        log_info "Phase 3: Auto-Provisioning Service"
        source "$MODULES_DIR/provision/install_service.sh"

        # 5. Secure Uplink (The Final Seal)
        # We run this LAST to lock the active internet connection
        log_info "Phase 5: Securing Uplink"
        source "$MODULES_DIR/system/tuning.sh"
        system_secure_uplink
        
        # x. (Future) VPN Setup
        # source "$MODULES_DIR/vpn/install.sh"
        
        log_success "Installation Complete! Use 'onyx provision' to configure keys."
        ;;
        
    provision)
        log_header "PROVISIONING SYSTEM"

        # Check if a config file path is provided as an argument
        if [ -n "$2" ]; then
             source "$MODULES_DIR/provision/ingest.sh"
             # Pass the file path to the ingest function
             provision_ingest "$2"
             exit $?
        fi
        
        # 1. LOAD CONFIG
        # We need the variables (ONYX_VPN_ENDPOINT, etc.) to be loaded first!
        if [ -f "$CORE_DIR/config_parser.sh" ]; then
             load_config
        fi

        # 2. RUN MODULES
        log_info "Phase 1: Configure VPN"
        source "$MODULES_DIR/vpn/wireguard/configure.sh"

        log_info "Phase 2: Configure Firewall (Safety Net)"
        source "$MODULES_DIR/network/safety_net.sh"

        # 3. SECURE UPLINK (The "Hotel" Fix)
        # This detects the NEW hotel connection and forces it to use safe DNS.
        log_info "Phase 3: Secure Uplink (DNS Lock)"
        source "$MODULES_DIR/system/tuning.sh"
        system_secure_uplink
        
        # 4. VERIFY
        # Simple check to see if services are active
        if systemctl is-enabled safety-net &> /dev/null; then
             log_success "System is PROVISIONED and LOCKED DOWN."
             log_info "Reboot recommended to apply all changes."
        else
             log_error "Provisioning failed. Firewall service not enabled."
        fi
        ;;

    config)
        log_header "APPLYING CONFIGURATION"
        # TODO: Ansible run tags=config
        log_warning "Config module not yet implemented."
        ;;

    status)
        # 1. Check if the diagnostic tool exists
        STATUS_SCRIPT="$ONYX_ROOT/core/onyx_status.sh"
        
        if [ -f "$STATUS_SCRIPT" ]; then
            # 2. Handoff control to the diagnostic engine
            # We execute it directly (instead of source) to keep its variables isolated
            sudo "$STATUS_SCRIPT"
        else
            log_error "Status module not found at $STATUS_SCRIPT"
            log_info "Please ensure core/onyx_status.sh exists and is executable."
        fi
        ;;

    update)
        log_header "RUNNING UPDATE MANAGER"
        source "$ONYX_ROOT/core/update.sh"
        core_update "$2"
        ;;

    gui)
        # Activates the Web Interface on demand
        source "$MODULES_DIR/system/gui.sh"
        system_activate_gui
        
        # Web Interface Configuration
        source "$MODULES_DIR/system/gui_ssl.sh"
        system_configure_gui
        ;;

    # === INSTALL DASHBOARD ===
    dashboard)
        source "$MODULES_DIR/system/dashboard.sh"
        system_install_dashboard
        ;;

    # === RUN MONITOR ===
    monitor)
        # Verify it is installed before trying to run it
        if [ -f "/usr/local/bin/onyx-dash" ]; then
            /usr/local/bin/onyx-dash
        else
            log_error "Dashboard not found. Run 'sudo onyx dashboard' first."
        fi
        ;;

    *)
        show_usage
        exit 1
        ;;
esac